#!/system/bin/sh

# Environment setup
export PATH="/data/adb/magisk:/data/adb/ksu/bin:/data/adb/ap/bin:$PATH:/data/data/com.termux/files/usr/bin"

# Logging function
log() {
  export TZ=Asia/Shanghai
  now=$(date +"[%Y-%m-%d %H:%M:%S %Z]")
  case $1 in
    Info) [ -t 1 ] && echo -e "\033[1;32m${now} [Info]: $2\033[0m" || echo "${now} [Info]: $2" ;;
    Warn) [ -t 1 ] && echo -e "\033[1;33m${now} [Warn]: $2\033[0m" || echo "${now} [Warn]: $2" ;;
    Error) [ -t 1 ] && echo -e "\033[1;31m${now} [Error]: $2\033[0m" || echo "${now} [Error]: $2" ;;
    *) [ -t 1 ] && echo -e "\033[1;30m${now} [$1]: $2\033[0m" || echo "${now} [$1]: $2" ;;
  esac
}

# Path to busybox and iw binaries
busybox="/data/adb/magisk/busybox"
iw="/data/data/com.termux/files/usr/bin/iw"

# Base directory for proxy service
box_path="/data/adb/box"

# Runtime directory for logs and PID files
run_path="/data/adb/box/run"

# Proxy binary details
bin_name="sing-box"
binfile="${box_path}/binary_files/sing-box"

# Configuration files
sourcefile="${box_path}/config_files/1.12.json"
workfile="${box_path}/config_files/1.12.json"

# PID file for the proxy service
pid_file="${run_path}/${bin_name}.pid"

# User and group for running the proxy service
box_user_group="0:23333"

# Proxy method (controls iptables mode: tproxy, enhance, tun)
proxy_method="enhance"

# Proxy mode (controls UID/GID filtering: blacklist, whitelist)
proxy_mode="blacklist"

# Network ports
tproxy_port="1536"
redir_port="7891"
tun_device="tun0"

# Subnets to bypass proxying
intranet=(0.0.0.0/8 10.0.0.0/8 100.0.0.0/8 127.0.0.0/8 169.254.0.0/16 192.0.0.0/24 192.0.2.0/24 192.88.99.0/24 192.168.0.0/16 198.51.100.0/24 203.0.113.0/24 224.0.0.0/4 240.0.0.0/4 255.255.255.255/32)
intranet6=(::/128 ::1/128 ::ffff:0:0/96 100::/64 64:ff9b::/96 2001::/32 2001:10::/28 2001:20::/28 2001:db8::/32 2002::/16 fe80::/10 ff00::/8)

# IPv6 support
ipv6="disable"

# List of packages to include/exclude based on proxy_mode
user_packages_list=(com.eg.android.AlipayGphone com.ss.android.article.lite)
# Format: Android User:Package Name, e.g., "0:com.android.captiveportallogin" "10:com.tencent.mm"

# Group IDs to bypass or proxy (based on proxy_mode)
gid_list=()

# Network interfaces for transparent proxying
ap_list=("wlan+" "ap+" "rndis+")
ignore_out_list=()
